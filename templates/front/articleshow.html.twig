{% extends 'base.html.twig' %}


{% block body %}

{% if article.status is same as false %}
<div class="container mt-3 mb-3">
    <h1> {{ article.title }}</h1>
    <div class="card mb-3">
        <div class="row g-0">
                <div class="col-md-8">
                <div class="card-body">
                    <h5 class="card-title">{{ article.author }}</h5>
                    <p class="card-text">{{ article.text }}</p>
                    <p class="card-text"><small class="text-body-secondary">Créé le {{ article.createdAt ? article.createdAt|date('Y-m-d H:i:s') : '' }}</small></p>
                    <p class="card-text"><small class="text-body-secondary">Mis à jour le {{ article.UpdatedAt ? article.UpdatedAt|date('Y-m-d H:i:s') : '' }}</small></p>
                </div>
                </div>
        </div>
    </div>
    <a href="/" class="btn btn-primary">Retour au Menu</a>
</div>
{% else %}
<div class="container mt-3 mb-3">
    <h1> {{ article.title }}</h1>
    <div class="card mb-3">
        <div class="row g-0">
                <div class="col-md-8">
                <div class="card-body">
                    <h5 class="card-title">{{ article.author }}</h5>
                    {% if hasPaid %}
                    
                    <p class="card-text">{{ article.text }}</p>
                    <p class="card-text"><small class="text-body-secondary">Créé le {{ article.createdAt ? article.createdAt|date('Y-m-d H:i:s') : '' }}</small></p>
                    <p class="card-text"><small class="text-body-secondary">Mis à jour le {{ article.UpdatedAt ? article.UpdatedAt|date('Y-m-d H:i:s') : '' }}</small></p>
                </div>
                    {% else %}
                        
                    <p> Vous devez payez pour accéder au contenu de cet article</p>
                    
                    {% endif %}
                    
                    {# <p class="card-text">{{ article.text }}</p>
                    <p class="card-text"><small class="text-body-secondary">Créé le {{ article.createdAt ? article.createdAt|date('Y-m-d H:i:s') : '' }}</small></p>
                    <p class="card-text"><small class="text-body-secondary">Mis à jour le {{ article.UpdatedAt ? article.UpdatedAt|date('Y-m-d H:i:s') : '' }}</small></p>
                </div> #}
                </div>
        </div>
    </div>
    <a href="/" class="btn btn-primary">Retour au Menu</a>

    <form action ="{{ path("subscription_payment", {'id': article.id }) }}" method="post" id="payment-form">
        <div class= "form-row">

            <div id="card-elements"></div>      
            
            <script src"https://js.stripe.com/v3"></script>

            <div id="card-errors" role="alert"></div>

        </div>

        <button class="btn btn-primary"> Acheter {{article.price}} € </button>
    </form>


</div>
        
{% endif %}

{% endblock %}

{% block javascripts %}
<script>

    {% if app_environement == 'dev' %}
        var stripeToken = "{{stripe_public_key_test}}";
    {% else %}
        var stripeToken = "{{stripe_public_key_live}}";
    {% endif %}
    
    var stripe = Stripe(stripeToken);
    var elements = stripe.elements();
    var subscription = "{{ article.id }}";
    var clientSecret = "{{ intentSecret }}";
    var cardholderEmail = "{{ app.user.email }}"


    console.log('clientSecret', clientSecret);

    var styleCustom = {
        base : {
            fontSize: '16px',
            color: '#25332d'
        }
    }

    var card = elements.create('card', {style = styleCustom});
    card.mount("#card-elements");
    
    card.addEventListener('change', function(event)){
        var displayError = document.getElementById('card-errors');

        if(event.errors) {

            displayError.textContent = event.error.message;

        } else {

            displayError.textContent = '';
        }


    };

    var form = document.getElementById('payment-form');
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        stripe.handleCardPayment(
            clientSecret,
            card,
            {
                payment_method_data:{
                    billing-details: {
                        email: cardholderEmail
                    }
                }
            }
        ).then(result) => {
            if(result.error) {
                // Display error
            } else if ('paymentIntent' in result){
                console.log('Result :', result);
                stripeTokenHandler(result.paymentIntent);

                console.log('Result paymentIntent :', result.paymentIntent);
            }
        }
    });

    function stripeTokenHandler(intent) {

        var form = var form = document.getElementById('payment-form');
        var InputIntentId = document.createElement('input');
        var InputIntentPaymentMethod = document.createElement('input');
        var InputIntentStatus = document.createElement('input');
        var InputSubscription = document.createElement('input');

        InputIntentId.setAttribute('type', 'hidden');
        InputIntentId.setAttribute('name', 'stripeIntentId');
        InputIntentId.setAttribute('value', intent.id);
        
        InputIntentPaymentMethod.setAttribute('type', 'hidden');
        InputIntentPaymentMethod.setAttribute('name', 'stripeIntentPaymentMethod');
        InputIntentPaymentMethod.setAttribute('value', intent.payment_method);

        InputIntentStatus.setAttribute('type', 'hidden');
        InputIntentStatus.setAttribute('name', 'stripeIntentStatus');
        InputIntentStatus.setAttribute('value', intent.status);

        InputSubscription.setAttribute('type', 'hidden');
        InputSubscription.setAttribute('name', 'subscription');
        InputSubscription.setAttribute('value', subscription);


        form.appendChild(InputIntentId);
        form.appendChild(InputIntentPaymentMethod);
        form.appendChild(InputIntentStatus);
        form.appendChild(InputSubscription);
        form.submit();
    }

</script>
{% endblock %}

